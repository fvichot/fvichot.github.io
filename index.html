<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Flo's Travels</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="css/leaflet.css" rel="stylesheet">
    <link href="css/bootstrap-switch.min.css" rel="stylesheet">
    <link href="css/colorbox.css" rel="stylesheet">

    <style>

    #brand-pic {
      width: 30px;
      height: 30px;
      display: inline;
      margin-right: 5px;
      border-radius: 50%;
    }

    .navbar {
      margin-bottom: 0px;
    }

    .bootstrap-switch-id-brad-mode {
      margin: 8px 5px 8px 5px;
    }

    #map {
      /*width: 600px;*/
      height: 300px;
    }

    #story-text p {
      font-family: Georgia, serif;
      text-align: justify;
    }

    .row-eq-height {
      display: -webkit-box;
      display: -webkit-flex;
      display: -ms-flexbox;
      display:         flex;
    }

    .nav-buttons {
      height: 100%;
      width: 100%;
      padding: 0px;
    }

    #story .col-md-1 {
      padding: 0px;
    }

    #footer {
      font-size: 8px;
      text-align: center;
    }

    #comment-frame {
      border: 0px;
      overflow: hidden ! important;
      height: 350px ! important;
      width: 100%;
    }

    #title-row {
      text-align: center;
    }

    #gallery img {
      max-height: 250px;
      max-width: 250px;
      margin-bottom: 3px;
      display: inline;
    }

    </style>
  </head>
  <body>

    <nav class="navbar navbar-inverse navbar-static-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#"><img id='brand-pic' src='images/me.jpg'></img>Flo's Travels</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><button type="button" class="btn btn-default navbar-btn" id="fit-trip-on-map"><span class="glyphicon glyphicon-globe"></span> Fit whole trip on map</button></li>
            <li><input id="brad-mode" type="checkbox" name="brad-mode-checkbox" data-label-text="Brad Mode" data-checked="false" autocomplete="off"></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div id="map" class="col-xs-12 col-sm-12 col-md-12"></div>
      </div>

      <div class="row row-eq-height" id='title-row'>
        <div class="col-xs-1 col-sm-1 col-md-1">
          <button type="submit" class="btn btn-default nav-buttons" id="button-prev"><span class="glyphicon glyphicon-chevron-left"></span></button>
        </div>
        <div class="col-xs-1 col-sm-1 col-md-1"><img id='story-flag'></img></div>
        <div class="col-xs-9 col-sm-9 col-md-9"><h1 id='story-title'></h1></div>
        <div class="col-xs-1 col-sm-1 col-md-1">
          <button type="submit" class="btn btn-default nav-buttons" id="button-next"><span class="glyphicon glyphicon-chevron-right"></span></button>
        </div>
      </div>

      <div class="row">
        <div id="story-pics" class="col-sm-3 col-sm-offset-1 col-md-3 col-md-offset-1"><p>Pics are empty.</p></div>
        <div id="story-text" class="col-sm-7 col-sm-offset-1 col-md-7 col-md-offset-1"><p>Trip is empty.</p></div>
      </div>

      <div class="row">
         <iframe id='comment-frame' class="col-lg-12 col-md-12 col-sm-12" />
       </iframe>
      </div>

      <div class="row">
        <div id="footer" class="col-sm-12 col-md-12"><span>Icons made by <a href="http://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></span> | <span>Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a></span></div>
      </div>
    </div>

    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/bootstrap-switch.min.js"></script>
    <script src="js/jquery.colorbox-min.js"></script>

    <script>
    // run when DOM is loaded
    $( document ).ready(function() {

      var bradModeSwitch = $("[name='brad-mode-checkbox']").bootstrapSwitch();
      bradModeSwitch.on("switchChange.bootstrapSwitch", toggleBradMode);

      var tripStops = [];

      L.Icon.Default.imagePath = 'images';
      var retinaSuffix = L.Browser.retina ? "@2x" : "";

      var map = L.map('map').setView([51.505, -0.09], 8);

      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}'+retinaSuffix+'.png?access_token=pk.eyJ1IjoiZnZpY2hvdCIsImEiOiIzYTQ3MGRiOGY4OTM3MmJiM2RkZjExZDY5ZGNiZTUyOCJ9.Gtkw7nSaBxzFxQtXDAxBHw', {
        maxZoom: 18,
        attribution: '',
        id: 'mapbox.streets'
      }).addTo(map);

      var travellerIcon = L.icon({
        iconUrl: 'images/traveller.svg',
        iconSize: [40, 40],
        iconAnchor: [30, 38],
        popupAnchor: [-3, -76],
        /*      shadowUrl: 'my-icon-shadow.png',
        shadowRetinaUrl: 'my-icon-shadow@2x.png',
        shadowSize: [68, 95],
        shadowAnchor: [22, 94]*/
      });

      var bradIcon = L.icon({
        iconUrl: 'images/brad.png',
        iconSize: [40, 40],
        iconAnchor: [35, 35],
        popupAnchor: [-3, -76],
        // shadowUrl: 'images/brad_shadow.png',
        // shadowSize: [50, 50],
        // shadowAnchor: [20, 30]
      });

      var travellerMarker = L.marker([0,0], {icon:travellerIcon, clickable: false}).addTo(map);
      var tripPath = L.polyline([], {color: 'red'}).addTo(map);

      $("#fit-trip-on-map").click(function() {map.fitBounds(tripPath.getBounds());});

      var currentStop = 0;

      var popup = L.popup();

      function onMapClick(e) {
        if( ! e.originalEvent.shiftKey) return;
        popup
        .setLatLng(e.latlng)
        .setContent("[" + e.latlng.lat + ", " + e.latlng.lng + "]")
        .openOn(map);
      }

      map.on('click', onMapClick);

      function toggleBradMode(event, state) {
        travellerMarker.setIcon(state ? bradIcon : travellerIcon);
      }

      function parseData(txt) {
        console.log("pouet pouet");
        data = [];
        lines = txt.split("\n");
        state = "title";
        dataIndex = 0;
        console.log("pouet pouet");
        for(i = 0; i < lines.length; i++) {
          line = lines[i];
          console.log(line);
          switch (state) {
            case "title":
            data[dataIndex] = {};
            data[dataIndex].title = line;
            state = "iso";
            break;

            case "iso":
            data[dataIndex].iso = line.toUpperCase();
            state = "latlng";
            break;

            case "latlng":
            tmp = line.split(' ');
            data[dataIndex].pos = [parseFloat(tmp[0]),parseFloat(tmp[1])];
            state = "img";
            break;

            case "img":
            if(line.startsWith("---")) {
              state = "text";
              break;
            }
            if ( ! data[dataIndex].pics) {
              data[dataIndex].pics = [];
            }
            sep = line.indexOf(' ');
            url = line.substr(sep);
            caption = line.slice(sep);
            data[dataIndex].pics.push() = [url,caption];
            break;

            case "text":
            if(line.startsWith("---")) {
              state = "title";
              break;
            }
            if ( ! data[dataIndex].text) {
              data[dataIndex].text = "";
            }
            data[dataIndex].text += line;
            break;

            default:
            console.log("CPT");
          }
        }
        return data;
      }

      function handleData(data) {
        console.log("pouet");
        tripStops = parseData(data);
        console.log("pouet");
        points = [];
        for(i = 0; i < tripStops.length; i++) {
          points[i] = L.latLng(tripStops[i].pos[0], tripStops[i].pos[1]);
          var marker = L.circleMarker(points[i], {fillColor: 'red', radius: 5});
          function onMarkerClick(e) {
            currentStop = e.target.stopIndex;
            generateNthStory(e.target.stopIndex);
          }
          marker.stopIndex = i;
          marker.on('click', onMarkerClick);
          marker.addTo(map);
        }
        tripPath.setLatLngs(points);
        map.fitBounds(tripPath.getBounds());

        generateNthStory(0);
      }

      function prevStop() {
        currentStop--;
        if(currentStop < 0) currentStop = 0;
        generateNthStory(currentStop);
      }

      function nextStop() {
        currentStop++;
        if(currentStop >= tripStops.length) currentStop = tripStops.length-1;
        generateNthStory(currentStop);
      }

      $('#button-next').click(nextStop);
      $('#button-prev').click(prevStop);

      function generateNthStory(n) {
        if(n <= 0) {
          n = 0;
          $('#button-prev').prop("disabled", true);
        } else {
          $('#button-prev').prop("disabled", false);
        }

        if(n >= tripStops.length-1) {
          n = tripStops.length-1;
          $('#button-next').prop("disabled", true);
        } else {
          $('#button-next').prop("disabled", false);
        }

        stop = tripStops[n];
        $('#story-title').text(stop.title);
        $('#story-flag').prop("src","images/flags/"+stop.iso.toUpperCase()+".png");
        $("#story-text").html("<p>" + stop.text + "</p>");
        var htmlContent = "<div id='gallery'>";
        for(i = 0; i < stop.pics.length; i++) {
          htmlContent += "<a  href='https://dl.dropboxusercontent.com/u/65019207/tripMap/" + stop.pics[i][0] + "' title='" + stop.pics[i][1] + "'><img src='https://dl.dropboxusercontent.com/u/65019207/tripMap/thumbs/" + stop.pics[i][0] + "' alt='" + stop.pics[i][1] + "'></img></a>";
        }
        htmlContent += "</div>";

        $("#story-pics").html(htmlContent);
        $('#gallery').find('a').colorbox({
          rel:'gal',
          maxWidth : '90%',
          maxHeight : '90%',
          opacity : 0.8,
          transition : 'elastic',
          current : '{current}/{total}'
        });

        travellerMarker.setLatLng(stop.pos);
        map.setView(stop.pos);
        window.disqus_title = stop.title;
        window.disqus_identifier = currentStop;
        var commentFrame = document.getElementById('comment-frame').contentWindow;
        if( ! commentFrame.src) {
          commentFrame.location = "comments.html";
        } else {
          commentFrame.location.reload(true);
        }
      }

      // Loaaaaaaaaaaaaad
      $.get({url:"trip.txt", dataType: "text", success: handleData}).fail(function( jqXHR, textStatus, errorThrown) {
        alert( "error:"+errorThrown );
      });

    // end on ready
    });

    function getDocHeight(doc) {
        doc = doc || document;
        // stackoverflow.com/questions/1145850/
        var body = doc.body, html = doc.documentElement;
        var height = Math.max( body.scrollHeight, body.offsetHeight,
            html.clientHeight, html.scrollHeight, html.offsetHeight );
            console.log(height);
        return height;
    }

    function setIframeHeight(id) {
        var ifrm = document.getElementById(id);
        var doc = ifrm.contentDocument? ifrm.contentDocument:
            ifrm.contentWindow.document;
        ifrm.style.visibility = 'hidden';
        ifrm.style.height = "10px"; // reset to minimal height ...
        // IE opt. for bing/msn needs a bit added or scrollbar appears
        ifrm.style.height = getDocHeight( doc ) + 4 + "px";
        ifrm.style.visibility = 'visible';
    }

    </script>
  </body>
</html>
